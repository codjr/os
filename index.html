<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/7/70/Logo_of_the_Brazilian_Navy_%28symbol%29.svg">
<title>OS EXTRATOR - DN 111.2</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
:root {
    --azul-escuro: #004080;
    --azul-medio: #0059b3;
    --azul-claro: #eaf1f8;
    --branco: #ffffff;
    --sombra: rgba(0,0,0,0.12);
}
body {
    font-family:"Segoe UI", Roboto, Arial, sans-serif;
    margin:0;
    background: var(--azul-claro);
    color: var(--azul-escuro);
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
}
header {
    width:100%;
    background:var(--azul-escuro);
    color:var(--branco);
    padding:20px 0;
    text-align:center;
    box-shadow:0 4px 12px var(--sombra);
    position:sticky;
    top:0;
    z-index:10;
}
header img {
    width:60px;
    vertical-align:middle;
    margin-right:12px;
}
header h1 {
    display:inline-block;
    font-size:24px;
    letter-spacing:0.6px;
    vertical-align:middle;
    font-weight:700;
}
.container {
    background: var(--branco);
    margin-top:50px;
    padding:40px 50px;
    border-radius:14px;
    box-shadow:0 8px 30px var(--sombra);
    width:90%;
    max-width:1100px;
    animation:fadeIn 0.6s ease;
}
@keyframes fadeIn { from { opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }
h2 {
    text-align:center;
    font-size:26px;
    color:var(--azul-medio);
    margin-bottom:25px;
    font-weight:700;
}
textarea {
    width:100%;
    height:180px;
    border:2px solid #ccc;
    border-radius:10px;
    padding:14px;
    font-size:14px;
    font-family:monospace;
    resize:vertical;
    box-shadow: inset 0 3px 6px rgba(0,0,0,0.08);
    transition:all 0.3s;
    margin-bottom:15px;
}
textarea:focus {
    outline:none;
    border-color:var(--azul-medio);
    box-shadow:0 0 0 4px rgba(0,89,179,0.15);
}
button {
    width:100%;
    margin-top:10px;
    padding:14px;
    background: linear-gradient(135deg,var(--azul-medio),var(--azul-escuro));
    color:var(--branco);
    font-size:16px;
    font-weight:700;
    border:none;
    border-radius:10px;
    cursor:pointer;
    transition: all 0.3s;
    box-shadow:0 4px 10px rgba(0,0,0,0.15);
}
button:hover {
    background: linear-gradient(135deg,var(--azul-escuro),var(--azul-medio));
    transform:translateY(-2px);
}
.resultado { margin-top:40px; animation:fadeIn 0.4s ease; }
.missao-card {
    border-left:6px solid var(--azul-medio);
    background:#f8fafc;
    border-radius:12px;
    padding:20px;
    margin-bottom:30px;
    box-shadow:0 4px 15px var(--sombra);
    transition: transform 0.3s, box-shadow 0.3s;
}
.missao-card:hover {
    transform:translateY(-3px);
    box-shadow:0 6px 20px var(--sombra);
}
.missao-card h3 {
    color:var(--azul-escuro);
    font-size:19px;
    margin-top:0;
    margin-bottom:15px;
}
table {
    width:100%;
    border-collapse:collapse;
    font-size:14px;
    background:var(--branco);
    border-radius:8px;
    overflow:hidden;
    box-shadow:0 0 0 1px #d0d7e2;
}
th, td { padding:10px 12px; border-bottom:1px solid #e2e6eb; text-align:left; }
th { background:var(--azul-medio); color:var(--branco); font-weight:600; }
tr:last-child td { border-bottom:none; }
tr:nth-child(even) td { background:#f3f6fa; }
.alerta { text-align:center; color:#b30000; font-weight:bold; margin-top:25px; }
footer {
    text-align:center;
    font-size:13px;
    color:#555;
    margin-top:40px;
    padding:15px 0 25px 0;
    width:100%;
    border-top:1px solid #d5d9de;
    background:#f4f7fa;
    box-shadow:0 -2px 5px rgba(0,0,0,0.05);
}
footer span { color:var(--azul-medio); font-weight:600; }
</style>
</head>
<body>

<header>
<img src="https://upload.wikimedia.org/wikipedia/commons/7/70/Logo_of_the_Brazilian_Navy_%28symbol%29.svg" alt="S√≠mbolo da Marinha">
<h1>OS EXTRATOR - DN 111.2</h1>
</header>

<div class="container">
<h2>Extra√ß√£o Autom√°tica de Dados de Miss√µes</h2>

<input type="file" id="fileInput" accept=".txt,.odt" style="margin-bottom:15px;">
<button onclick="lerArquivo()">Carregar Arquivo (.txt ou .odt) e Processar</button>

<textarea id="inputText" placeholder="Ou cole aqui o texto do documento..."></textarea>
<button onclick="processar()">Processar Documento</button>

<div id="result" class="resultado"></div>
</div>

<footer id="footer"></footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
const meses = { "JAN":1,"FEV":2,"MAR":3,"ABR":4,"MAI":5,"JUN":6,"JUL":7,"AGO":8,"SET":9,"OUT":10,"NOV":11,"DEZ":12 };

function formatarDataAtual(){ 
    const agora=new Date(); 
    const mesesArr=["JAN","FEV","MAR","ABR","MAI","JUN","JUL","AGO","SET","OUT","NOV","DEZ"]; 
    const dia=String(agora.getDate()).padStart(2,'0'); 
    const mes=mesesArr[agora.getMonth()]; 
    const ano=agora.getFullYear(); 
    return `${dia}/${mes}/${ano}`; 
}

function lerArquivo(){
    const file=document.getElementById("fileInput").files[0];
    if(!file){ alert("Selecione um arquivo .txt ou .odt!"); return; }
    const reader=new FileReader();
    if(file.name.toLowerCase().endsWith(".txt")){
        reader.onload=function(e){ document.getElementById("inputText").value=e.target.result; processar(); };
        reader.readAsText(file,"UTF-8");
    } else if(file.name.toLowerCase().endsWith(".odt")){
        reader.onload=function(e){
            JSZip.loadAsync(e.target.result).then(function(zip){
                return zip.file("content.xml").async("string");
            }).then(function(xmlText){
                const parser=new DOMParser();
                const xmlDoc=parser.parseFromString(xmlText,"text/xml");
                let texto="";
                const ps=xmlDoc.getElementsByTagName("text:p");
                for(let i=0;i<ps.length;i++){ texto+=ps[i].textContent+"\n"; }
                document.getElementById("inputText").value=texto;
                processar();
            }).catch(err=>alert("Erro ao ler o arquivo .odt: "+err));
        };
        reader.readAsArrayBuffer(file);
    }
}

function converterData(text, mesPadrao, anoPadrao){
    if(!text) return "-";
    text=text.toUpperCase().replace(/\s+/g,'');
    const match=text.match(/(\d{2})(\d{2})(\d{2})P(?:\/?([A-Z]{3}))?(?:\/?(\d{4}))?/);
    if(!match) return "Formato inv√°lido";
    const [,dia,hora,minuto,mesStr,anoStr]=match;
    const mes = mesStr ? meses[mesStr] : mesPadrao ? meses[mesPadrao] : 1;
    const ano = anoStr ? anoStr : anoPadrao ? anoPadrao : "YYYY";
    return `${dia}/${String(mes).padStart(2,'0')}/${ano} ${hora}:${minuto}`;
}

function processar(){
    const input=document.getElementById("inputText").value.trim();
    const linhas=input.split(/\n+/).map(l=>l.trim()).filter(l=>l.length>0);
    const parsedData=[];
    let currentMission=null;

    for(let i=0;i<linhas.length;i++){
        const linha=linhas[i];
        let omsAno=null, omsMes=null, oms="-";
        const omsMatch=linha.match(/\(?\s*OMS\s*(?:n[¬∫o]?|:)?\s*([0-9]+)\/(\d{4})\)?/i);
        if(omsMatch){ oms=omsMatch[1]+"/"+omsMatch[2]; omsAno=omsMatch[2]; }

        const periodoMatch=linha.match(/no per√≠odo de (\d{6}P(?:\/?[A-Z]{3}(?:\/?\d{4})?)?)\s*a\s*(\d{6}P(?:\/?[A-Z]{3}(?:\/?\d{4})?)?)/i);
        if(periodoMatch){
            if(currentMission) parsedData.push(currentMission);
            let codigoMensagem="-";
            for(let j=i;j<i+6 && j<linhas.length;j++){
                const l=linhas[j];
                const codigoMsgMatch=l.match(/\b(?:mensagem|msg)\s*([A-Z0-9\-\/]+)/i);
                const omsMatch2=l.match(/\(?\s*OMS\s*(?:n[¬∫o]?|:)?\s*([0-9]+)\/(\d{4})\)?/i);
                if(codigoMsgMatch) codigoMensagem=codigoMsgMatch[1];
                if(omsMatch2){ oms=omsMatch2[1]+"/"+omsMatch2[2]; if(!omsAno) omsAno=omsMatch2[2]; if(!omsMes) omsMes=omsMatch2[1]; }
            }
            currentMission={
                dataInicial:converterData(periodoMatch[1], omsMes, omsAno),
                dataFinal:converterData(periodoMatch[2], omsMes, omsAno),
                codigoMensagem,
                oms,
                militares:[]
            };
            continue;
        }

        if(currentMission && i+2<linhas.length){
            const posto=linhas[i]; const nip=linhas[i+1]; const nome=linhas[i+2];
            if(/^\d{2}\.\d{4}\.\d{2,3}$/.test(nip)){
                currentMission.militares.push({posto,nip,nome});
                i+=2;
            }
        }
    }
    if(currentMission) parsedData.push(currentMission);
    exibirResultado(parsedData);
}

function exibirResultado(parsedData){
    const resultDiv=document.getElementById("result");
    if(parsedData.length===0){ 
        resultDiv.innerHTML=`<p class="alerta">Nenhum deslocamento identificado. Verifique o texto e tente novamente.</p>`; 
        return; 
    }
    let html="";
    parsedData.forEach((missao,idx)=>{
        html+=`<div class="missao-card"><h3>üìò Miss√£o ${idx+1}</h3><table>
        <tr><th>Data Inicial</th><th>Data Final</th><th>C√≥digo da Mensagem</th><th>OMS</th><th>Posto/Gradua√ß√£o</th><th>NIP</th><th>Nome</th></tr>`;
        if(missao.militares.length>0){
            missao.militares.forEach(m=>{
                html+=`<tr><td>${missao.dataInicial}</td><td>${missao.dataFinal}</td><td>${missao.codigoMensagem}</td><td>${missao.oms}</td><td>${m.posto}</td><td>${m.nip}</td><td>${m.nome}</td></tr>`;
            });
        } else{
            html+=`<tr><td>${missao.dataInicial}</td><td>${missao.dataFinal}</td><td>${missao.codigoMensagem}</td><td>${missao.oms}</td><td colspan="3" style="text-align:center;">Sem militares registrados</td></tr>`;
        }
        html+="</table></div>";
    });
    resultDiv.innerHTML=html;
}

document.getElementById("footer").innerHTML=`Sistema em uso por: <span>MN NELSON</span> ‚Äî Atualizado em <span>${formatarDataAtual()}</span><br>¬© 2025 - OS EXTRATOR - DN 111.2 | Sistema de Apoio Administrativo Interno.`;
</script>

</body>
</html>
